var Y=Object.defineProperty,X=Object.defineProperties;var ee=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var te=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var W=(t,e,n)=>e in t?Y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,m=(t,e)=>{for(var n in e||(e={}))te.call(e,n)&&W(t,n,e[n]);if(R)for(var n of R(e))ne.call(e,n)&&W(t,n,e[n]);return t},y=(t,e)=>X(t,ee(e));import{f as ie,t as b,s as w,C as k,dY as ae,ce as se,k as $,cP as re,r as x,bs as Z,cd as oe}from"./index.1411fdd8.js";import{s as le,n as ce,t as de}from"./featureConversionUtils.915b67be.js";import{e as ue}from"./OptimizedFeatureSet.ec9a3456.js";import{O as fe,T as me,L as pe}from"./geojson.31586015.js";import{n as ge}from"./clientSideDefaults.714fb2ac.js";const O=ie.getLogger("esri.layers.graphics.sources.ogcfeature"),K="http://www.opengis.net/def/crs/",Se=`${K}OGC/1.3/CRS84`;async function ve(t,e,n={},i=5){const{links:o}=t,l=p(o,"items","application/geo+json")||p(o,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(b(l))throw new w("ogc-feature-layer:missing-items-page","Missing items url");const{data:d}=await k(l.href,{signal:n.signal,query:y(m({limit:i},n.customParameters),{token:n.apiKey}),headers:{accept:"application/geo+json"}});await fe(d);const s=me(d,{geometryType:e.geometryType}),f=e.fields||s.fields||[],S=e.hasZ!=null?e.hasZ:s.hasZ,T=s.geometryType,g=e.objectIdField||s.objectIdFieldName||"OBJECTID";let r=e.timeInfo;const h=f.find(a=>a.name===g);if(h)h.type="esriFieldTypeOID",h.editable=!1,h.nullable=!1;else{if(!s.objectIdFieldType)throw new w("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");f.unshift({name:g,alias:g,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(g!==s.objectIdFieldName){const a=f.find(c=>c.name===s.objectIdFieldName);a&&(a.type="esriFieldTypeInteger")}f===s.fields&&s.unknownFields.length>0&&O.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:s.unknownFields}});for(const a of f){if(a.name==null&&(a.name=a.alias),a.alias==null&&(a.alias=a.name),a.type!=="esriFieldTypeOID"&&a.type!=="esriFieldTypeGlobalID"&&(a.editable=a.editable==null||!!a.editable,a.nullable=a.nullable==null||!!a.nullable),!a.name)throw new w("ogc-feature-layer:invalid-field-name","field name is missing",{field:a});if(ae.jsonValues.indexOf(a.type)===-1)throw new w("ogc-feature-layer:invalid-field-type",`invalid type for field "${a.name}"`,{field:a})}if(r){const a=new se(f);if(r.startTimeField){const c=a.get(r.startTimeField);c?(r.startTimeField=c.name,c.type="esriFieldTypeDate"):r.startTimeField=null}if(r.endTimeField){const c=a.get(r.endTimeField);c?(r.endTimeField=c.name,c.type="esriFieldTypeDate"):r.endTimeField=null}if(r.trackIdField){const c=a.get(r.trackIdField);c?r.trackIdField=c.name:(r.trackIdField=null,O.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:r}}))}r.startTimeField||r.endTimeField||(O.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:r}}),r=null)}return{drawingInfo:T?ge(T):null,geometryType:T,fields:f,hasZ:!!S,objectIdField:g,timeInfo:r}}async function Ne(t,e={}){const{links:n}=t,i=p(n,"data","application/json")||p(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(b(i))throw new w("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:l,signal:d}=e,{data:s}=await k(i.href,{signal:d,headers:{accept:"application/json"},query:y(m({},l),{token:o})});return s}async function Me(t,e={}){const{links:n}=t,i=p(n,"conformance","application/json")||p(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(b(i))throw new w("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:l,signal:d}=e,{data:s}=await k(i.href,{signal:d,headers:{accept:"application/json"},query:y(m({},l),{token:o})});return s}async function Oe(t,e={}){const{apiKey:n,customParameters:i,signal:o}=e,{data:l}=await k(t,{signal:o,headers:{accept:"application/json"},query:y(m({},i),{token:n})});return l}async function qe(t,e={}){const n="application/vnd.oai.openapi+json;version=3.0",i=p(t.links,"service-desc",n);if(b(i))return O.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:l,signal:d}=e,{data:s}=await k(i.href,{signal:d,headers:{accept:n},query:y(m({},l),{token:o})});return s}function Ce(t){const e=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(t),n=e==null?void 0:e.groups;if(!n)return null;const{authority:i,code:o}=n;switch(i.toLowerCase()){case"ogc":switch(o.toLowerCase()){case"crs27":return $.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return $.WGS84.wkid;default:return null}case"esri":case"epsg":{const l=Number.parseInt(o,10);return Number.isNaN(l)?null:l}default:return null}}async function Pe(t,e,n){const i=await ye(t,e,n);return le(i)}async function ye(t,e,n){const{capabilities:{query:{maxRecordCount:i}},collection:o,layerDefinition:l,queryParameters:{apiKey:d,customParameters:s},spatialReference:f,supportedCrs:S}=t,{links:T}=o,g=p(T,"items","application/geo+json")||p(T,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(b(g))throw new w("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:r,num:h,start:a,timeExtent:c,where:A}=e;if(e.objectIds)throw new w("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const J=$.fromJSON(f),j=re(e.outSpatialReference,J),v=j.isWGS84?null:L(j,S),E=Fe(r,S),_=be(c),B=he(A),Q=h!=null?h:a!=null&&a!==void 0?10:i,{data:F}=await k(g.href,y(m({},n),{query:y(m(m({},s),E),{crs:v,datetime:_,query:B,limit:Q,startindex:a,token:d}),headers:{accept:"application/geo+json"}}));let N=!1;F.links&&(N=!!F.links.find(M=>M.rel==="next")),!N&&Number.isInteger(F.numberMatched)&&Number.isInteger(F.numberReturned)&&(N=F.numberReturned<F.numberMatched);const{fields:V,globalIdField:z,hasM:H,hasZ:q,objectIdField:C}=l,P=l.geometryType,D=pe(F,{geometryType:P,hasZ:q,objectIdField:C});if(!v&&j.isWebMercator){for(const I of D)if(x(I.geometry)){const M=ce(I.geometry,P,q,!1);M.spatialReference=$.WGS84,I.geometry=de(Z(M,j))}}for(const I of D)I.objectId=I.attributes[C];const U=v||!v&&j.isWebMercator?j.toJSON():oe,u=new ue;return u.exceededTransferLimit=N,u.features=D,u.fields=V,u.geometryType=P,u.globalIdFieldName=z,u.hasM=H,u.hasZ=q,u.objectIdFieldName=C,u.spatialReference=U,u}function we(t){return x(t)&&t.type==="extent"}function L(t,e){var n,i,o;const{isWebMercator:l,wkid:d}=t;if(!d)return null;const s=l?(n=(i=(o=e[3857])!=null?o:e[102100])!=null?i:e[102113])!=null?n:e[900913]:e[t.wkid];return s?`${K}${s}`:null}function G(t){if(b(t))return"";const{xmin:e,ymin:n,xmax:i,ymax:o}=t;return`${e},${n},${i},${o}`}function be(t){if(b(t))return null;const{start:e,end:n}=t;return`${x(e)?e.toISOString():".."}/${x(n)?n.toISOString():".."}`}function he(t){return b(t)||!t||t==="1=1"?null:t}function Fe(t,e){if(!we(t))return null;const{spatialReference:n}=t;if(!n||n.isWGS84)return{bbox:G(t)};const i=L(n,e);return x(i)?{bbox:G(t),"bbox-crs":i}:n.isWebMercator?{bbox:G(Z(t,$.WGS84))}:null}function p(t,e,n){return t.find(i=>i.rel===e&&i.type===n)||t.find(i=>i.rel===e&&!i.type)}export{Se as F,ve as I,Pe as N,qe as S,Ne as T,K as j,Me as k,ye as q,Ce as v,Oe as x};
