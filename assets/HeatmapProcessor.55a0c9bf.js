var D=Object.defineProperty,G=Object.defineProperties;var L=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable;var I=(t,e,r)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,K=(t,e)=>{for(var r in e||(e={}))P.call(e,r)&&I(t,r,e[r]);if(_)for(var r of _(e))H.call(e,r)&&I(t,r,e[r]);return t},E=(t,e)=>G(t,L(e));import{E as V,H as j,e3 as q,r as z,ei as C}from"./index.32114bf6.js";import{o as W}from"./enums.94a84b2b.js";import{p as Y,l as d}from"./tileUtils.3e985f74.js";import"./TileKey.10b9e8d7.js";(()=>{if(!("document"in globalThis))return()=>null;const t=document.createElement("canvas"),e=t.getContext("2d"),r=512;return t.height=r,t.width=1,s=>{e.clearRect(0,0,1,t.height);const a=e.createLinearGradient(0,0,0,t.height);for(const{ratio:i,color:n}of s)a.addColorStop(Math.max(i,.001),`rgba(${n.r}, ${n.g}, ${n.b}, ${n.a})`);return e.fillStyle=a,e.fillRect(0,0,1,t.height),e.getImageData(0,0,1,t.height).data}})();function B(t,e,r,s){const{blurRadius:a,fieldOffset:i,field:n}=e,p=new Float64Array(r*s),y=J(a),h=Math.round(3*a);let c,u=Number.NEGATIVE_INFINITY;const m=Q(n,i),g=new Set;for(const b of t){const f=b.getCursor();for(;f.next();){const M=f.getObjectId();if(g.has(M))continue;g.add(M);const o=f.readLegacyPointGeometry(),T=128;if(o.x<-T||o.x>=r+T||o.y<-T||o.y>s+T)continue;const O=+m(f),F=Math.round(o.x)-h,S=Math.round(o.y)-h,U=Math.max(0,F),v=Math.max(0,S),R=Math.min(s,Math.round(o.y)+h),A=Math.min(r,Math.round(o.x)+h);for(let w=v;w<R;w++){const N=y[w-S];for(let x=U;x<A;x++){const $=y[x-F];c=p[w*r+x]+=N*$*O,c>u&&(u=c)}}}}return{matrix:p.buffer,max:u}}function J(t){const e=Math.round(3*t),r=2*t*t,s=new Float64Array(2*e+1);for(let a=0;a<=s.length;a++)s[a]=Math.exp(-((a-e)**2)/r)/Math.sqrt(2*Math.PI)*(t/2);return s}function Q(t,e){return t!=null?typeof e=="string"?r=>-1*+r.readAttribute(t):r=>+r.readAttribute(t)+e:r=>1}class l{constructor(e,r){this.offset=e,this.extent=r}}function X(t){const e=t.key,r=new Map,s=256,a=W,i=t.tileInfoView.tileInfo.isWrappable;return r.set(d(e,-1,-1,i).id,new l([-a,-a],[a-s,a-s,a,a])),r.set(d(e,0,-1,i).id,new l([0,-a],[0,a-s,a,a])),r.set(d(e,1,-1,i).id,new l([a,-a],[0,a-s,s,a])),r.set(d(e,-1,0,i).id,new l([-a,0],[a-s,0,a,a])),r.set(d(e,1,0,i).id,new l([a,0],[0,0,s,a])),r.set(d(e,-1,1,i).id,new l([-a,a],[a-s,0,a,s])),r.set(d(e,0,1,i).id,new l([0,a],[0,0,a,s])),r.set(d(e,1,1,i).id,new l([a,a],[0,0,s,s])),r}let k=class extends Y{constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(t,e){const r=e.schema.processors[0];r.type==="heatmap"&&q(this._schema,r)&&(t.mesh=!0,this._schema=r)}onTileUpdate(t){for(const e of t.removed)this._tileKeyToFeatureSets.delete(e.key.id)}onTileClear(t){const e={clear:!0};return this._tileKeyToFeatureSets.delete(t.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:e})}async onTileMessage(t,e,r){this._tileKeyToFeatureSets.has(t.key.id)||this._tileKeyToFeatureSets.set(t.key.id,new Map);const s=this._tileKeyToFeatureSets.get(t.key.id);if(z(e.addOrUpdate)&&e.addOrUpdate.hasFeatures&&s.set(e.addOrUpdate.instance,e),e.end){const a=[],i=X(t);this._tileKeyToFeatureSets.forEach((h,c)=>{if(c===t.key.id)h.forEach(u=>C(u.addOrUpdate,m=>a.push(m)));else if(i.has(c)){const u=i.get(c),[m,g]=u.offset;h.forEach(b=>C(b.addOrUpdate,f=>{const M=f.transform(m,g,1,1);a.push(M)}))}});const n=B(a,this._schema.mesh,512,512),p={tileKey:t.key.id,intensityInfo:n},y=[n.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",p,E(K({},r),{transferList:y}))}}onTileError(t,e,r){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:e},r)}};k=V([j("esri.views.2d.layers.features.processors.HeatmapProcessor")],k);const se=k;export{se as default};
